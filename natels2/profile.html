<html>
  <head>
    <title>Amphibians of Georgia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">

    <style>

.latin {
font: italic bold 30px serif;
}

#sname {
font: normal normal 27px serif;
margin-top: 10px;
}

body  {
background: url(img/cyp.jpeg) no-repeat fixed top left;
margin-left: auto;
margin-right: auto;
padding: 10px;
}

header, section, text {
width: 900px;
margin: auto;
background-color: rgba(255,255,255,0.85);
margin-top: 0;
padding: 1em;
}

    </style>
  </head>
  <body>
  <section>
    <div id="primary-image"></div>
    <div id="carto-data"></div>
    <div id="fusion-data"></div>
    <div id="supplemental-images"></div>
  </section>

<script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>

<script>

function getURLParameter(name) {
    return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null
    }

var current_es_id = getURLParameter('es_id');
var fusion_table = getURLParameter('fus_tab_id');

// Put primary image at top of page
(function() {
    var flickerAPI = "http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?";
    $.getJSON( flickerAPI, {
        tags: "ga_es_id_" + current_es_id + "_1",
		user_id: "georgiafishes",
		extras: "description",
        tagmode: "any",
        format: "json"
    }, Primary)
	
	function Primary(data) {
	  if (data.items != 0){
      $.each( data.items, function( i, item ) {
	  var link = item.media.m
	  link = link.replace('_m', '_z');
	  $( "<img>" ).attr( "src", link).appendTo( "#primary-image" );
	}); //end of each
    }//end of if
	else {
	var errorHTML = '<img src=img/noimage.png></img>';
	$(errorHTML).appendTo("#primary-image");
	}
	};
})();
		var query = "SELECT * FROM " + 
		fusion_table + ' WHERE ES_ID =' + current_es_id;
        var encodedQuery = encodeURIComponent(query);
		
        // Construct the URL
        var url = ['https://www.googleapis.com/fusiontables/v2/query'];
        url.push('?sql=' + encodedQuery);
        url.push('&key=AIzaSyCHzvDOeABC3-ZYDMnERKvv05qB4GpYceI');
        url.push('&callback=?');
		var html =  '';
		
// Send the JSONP request using jQuery
        $.ajax({ url: url.join(''), dataType: 'jsonp', success: function (data) {
		
			var columns = data['columns'];
            var rows = data['rows'];
			var i = 0;
			for (var c = 3; c < columns.length; c++) {
				row_value = mmd(rows[0][c]);
				column_value = columns[c];	
				if (column_value == 'References'){
				var reference = row_value.replace(/(?:\r\n|\r|\n)/g,'<br />');
				html += '<p><b>References</b></br>' + reference + '</p>';
				i++;
				}
				else{
				html += '<p><b>' + column_value + '</b></br>' + row_value + '</p>';	
				i++;
				}
				}
			
			
			document.getElementById('fusion-data').innerHTML = html;
		}
		});

// Place Carto data in page.
var sql = "SELECT es_id, sname ,scomname ,exportdate ,author ,swapstatus ,sprot ,usesa ,srank ,grank FROM es_web_all WHERE es_id = " + current_es_id;
var url = 'http://gakrakow.cartodb.com/api/v2/sql?q=' + sql;
$.getJSON(url, function(data) {
    var rec = data.rows[0];
    //alert(JSON.stringify(rec));
    var html = ''
    html += '<div id="sname"><span class="latin">' + rec.sname + '</span> ' + rec.author + '</div>';
    html += '<p><b>Common Name: </b>' + rec.scomname + '</p>';
    html += '<p><b>Federal Protection: </b>' + rec.usesa + '</p>';
    html += '<p><b>State Protection: </b>' + rec.sprot + '</p>';
    html += '<p><b>Global Rank: </b>' + rec.grank + '</p>';
    html += '<p><b>State Rank: </b>' + rec.srank + '</p>';
    var swap;
    if (rec.swapstatus == 1) {
        swap = 'Yes';
    } else {
        swap = 'No';
    }
    html += '<p><b>SWAP Status: </b>' + swap + '</p>';
    document.getElementById('carto-data').innerHTML = html;
});

(function (){

    var flickerAPI = "http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?";
	for (x = 2; x < 9; x++) {
    $.getJSON( flickerAPI, {
		user_id: "141637440@N07", // change to flickr id to scan only that page
        tags: "ga_es_id_" + current_es_id + "_" + x,
        tagmode: "any",
        format: "json", 
    })	
    .done(function( data ) {
      $.each( data.items, function( i, item ) {
	    var desc_pos = $(item.description).text().lastIndexOf(":");
		var desc = $(item.description).text().slice(desc_pos + 1);
        var link = item.media.m;
		var flick_link = item.link
        link = link.replace('_m', '_z');
        $( "<img>" ).attr( "src", link).appendTo( "#supplemental-images" );
		$('img').wrap("<a href=" + flick_link +"> </a>");
		$("<figcaption>" + desc  + "</figcaption>").appendTo("#supplemental-images");	
      });	  
    });		
		}
})();

// function obtained at https://github.com/p01/mmd.js
function mmd(s)
{
var h='';
function E(s)
{
return new Option(s).innerHTML
}
function I(s)
{
return E(s)
.replace(/!\[([^\]]*)]\(([^(]+)\)/g,'<img alt="$1"src="$2">')
.replace(/\[([^\]]+)]\(([^(]+)\)/g,'$1'.link('$2'))
.replace(/`([^`]+)`/g,'<code>$1</code>')
.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
.replace(/\*([^*]+)\*/g,'<em>$1</em>')
}
s.replace(/^\s+|\r|\s+$/g,'')
.replace(/\t/g,'    ').split(/\n\n+/).forEach
(function(b,f,R)
{
R={
'*':[/\n\* /,'<ul><li>','</li></ul>']
,1  :[/\n[1-9]\d*\.? /,'<ol><li>','</li></ol>']
,' ':[/\n    /,'<pre><code>','</pre></code>','\n']
,'>':[/\n> /,'<blockquote>','</blockquote>','\n']}
[f=b[0]];h+=R?R[1]+('\n'+b).split(R[0]).slice(1).map(R[3]?E:I).join(R[3]||'</li>\n<li>')+R[2]
:f=='#'?'<h'+(f=b.indexOf(' '))+'>'+I(b.slice(f+1))+'</h'+f+'>'
:f=='<'?b:'<p>'+I(b)+'</p>'
});return h
};
		
 </script>
 
</body>
</html>
